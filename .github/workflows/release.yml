name: Release

# Gitflow Release — triggered only by version tags (v*.*.*).
#
# Tag on main/master  →  full release,   Docker :latest + :1.2.3
# Tag on develop      →  pre-release,    Docker :1.2.3 only, no :latest
# Tag with -rc/-beta/-alpha → always pre-release regardless of branch

on:
  push:
    tags:
      - 'v*.*.*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DOCKERHUB_IMAGE: mschwehl/matrosdms

jobs:

  # ============================
  # STEP 1: Determine release type & build
  # ============================
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      version:       ${{ steps.version.outputs.VERSION }}
      is_prerelease: ${{ steps.branchcheck.outputs.IS_PRERELEASE }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0    # needed to inspect which branch the tag is on

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Check which branch this tag is on
        id: branchcheck
        run: |
          # Check if tag commit exists on main or master
          ON_MAIN=$(git branch -r --contains ${{ github.sha }} | grep -E '^\s*origin/(main|master)$' | head -1 || true)

          # Pre-release if: not on main/master, OR tag name contains -rc/-beta/-alpha
          if [ -z "$ON_MAIN" ] || echo "${{ github.ref }}" | grep -qE '\-(rc|beta|alpha)'; then
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
            echo "→ PRE-RELEASE (tag not on main/master or contains rc/beta/alpha)"
          else
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
            echo "→ FULL RELEASE (tag is on main/master)"
          fi

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Cache NPM dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Build backend + frontend
        run: mvn -B install -Pwith-frontend -DskipTests -Drevision=${{ env.APP_VERSION }}

      - name: Verify JAR exists
        run: ls -lh server/target/server-${{ env.APP_VERSION }}.jar

      - name: Upload server JAR
        uses: actions/upload-artifact@v4
        with:
          name: server-jar
          path: server/target/server-${{ env.APP_VERSION }}.jar
          if-no-files-found: error

  # ============================
  # STEP 2a: Windows portable (jpackage, no Maven recompile)
  # ============================
  build-windows-portable:
    runs-on: windows-latest
    needs: build
    env:
      APP_VERSION: ${{ needs.build.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Download server JAR
        uses: actions/download-artifact@v4
        with:
          name: server-jar
          path: jpackage-input

      - name: Create Windows portable app-image
        shell: pwsh
        run: |
          $version = "${{ env.APP_VERSION }}"
          jpackage `
            --name MatrosDMS `
            --app-version $version `
            --description "Matrosdms Document Management System" `
            --vendor "Matrosdms" `
            --input jpackage-input `
            --main-jar "server-$version.jar" `
            --dest portable `
            --type app-image `
            --java-options "-Xmx2048m" `
            --java-options "-Dspring.profiles.active=prod" `
            --java-options "--enable-preview" `
            --win-console

      - name: Zip portable app-image
        shell: pwsh
        run: |
          $version = "${{ env.APP_VERSION }}"
          Compress-Archive -Path "portable\*" -DestinationPath "MatrosDMS-$version-windows-portable.zip"

      - name: Upload Windows portable artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-portable
          path: MatrosDMS-*-windows-portable.zip
          if-no-files-found: error

  # ============================
  # STEP 2b: Linux tar.gz (jpackage app-image)
  # ============================
  build-linux-targz:
    runs-on: ubuntu-latest
    needs: build
    env:
      APP_VERSION: ${{ needs.build.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Download server JAR
        uses: actions/download-artifact@v4
        with:
          name: server-jar
          path: jpackage-input

      - name: Create Linux app-image with jpackage
        run: |
          VERSION=${{ env.APP_VERSION }}
          jpackage \
            --name MatrosDMS \
            --app-version "$VERSION" \
            --description "Matrosdms Document Management System" \
            --vendor "Matrosdms" \
            --input jpackage-input \
            --main-jar "server-$VERSION.jar" \
            --dest linux-image \
            --type app-image \
            --java-options "-Xmx2048m" \
            --java-options "-Dspring.profiles.active=prod" \
            --java-options "--enable-preview"

      - name: Create tar.gz
        run: |
          VERSION=${{ env.APP_VERSION }}
          tar -czf "MatrosDMS-$VERSION-linux.tar.gz" -C linux-image .

      - name: Upload Linux tar.gz artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-targz
          path: MatrosDMS-*-linux.tar.gz
          if-no-files-found: error

  # ============================
  # STEP 2c: Docker image
  # Full release  →  :latest + :1.2.3 + :1.2 + :1
  # Pre-release   →  :1.2.3-rc1 only  (no :latest)
  # ============================
  docker-release:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: write
    env:
      APP_VERSION:   ${{ needs.build.outputs.version }}
      IS_PRERELEASE: ${{ needs.build.outputs.is_prerelease }}

    steps:
      - uses: actions/checkout@v4

      - name: Download server JAR
        uses: actions/download-artifact@v4
        with:
          name: server-jar
          path: server/target

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
            ${{ env.DOCKERHUB_IMAGE }}
          tags: |
            # semver tags always (full and pre-releases)
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            # :latest only on full releases — never on pre-releases
            type=raw,value=latest,enable=${{ needs.build.outputs.is_prerelease == 'false' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./infra/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================
  # STEP 3: GitHub Release
  # ============================
  github-release:
    runs-on: ubuntu-latest
    needs:
      - build
      - build-windows-portable
      - build-linux-targz
      - docker-release
    permissions:
      contents: write
    env:
      APP_VERSION: ${{ needs.build.outputs.version }}

    steps:
      - name: Download Windows portable
        uses: actions/download-artifact@v4
        with:
          name: windows-portable
          path: release-assets

      - name: Download Linux tar.gz
        uses: actions/download-artifact@v4
        with:
          name: linux-targz
          path: release-assets

      - name: Download headless JAR
        uses: actions/download-artifact@v4
        with:
          name: server-jar
          path: release-assets-jar

      - name: Rename headless JAR
        run: |
          VERSION=${{ env.APP_VERSION }}
          cp release-assets-jar/server-$VERSION.jar release-assets/MatrosDMS-$VERSION-headless.jar

      - name: List release assets
        run: ls -lh release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ needs.build.outputs.is_prerelease == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
